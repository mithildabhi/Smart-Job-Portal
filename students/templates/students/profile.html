{% extends 'student_base.html' %}
{% load static %}

{% block title %}My Profile - Smart Job Portal{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_profile.css' %}">
{% endblock %}

{% block content %}
<!-- Profile Header -->
<div class="profile-header">
  <div class="profile-content">
    <div class="profile-avatar" id="profile-avatar-container">
      {% if profile.profile_picture %}
        <img src="{{ profile.profile_picture.url }}" alt="Profile Picture" id="profile-image">
        <div class="avatar-overlay">
          <div class="avatar-actions">
            <button class="btn-avatar-action" onclick="openImageModal()" title="Change Picture">
              <i class="fas fa-camera"></i>
            </button>
            <button class="btn-avatar-action" onclick="deleteProfilePicture()" title="Delete Picture">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      {% else %}
        <i class="fas fa-user-graduate" id="default-avatar"></i>
        <div class="avatar-overlay">
          <button class="btn-avatar-action" onclick="openImageModal()" title="Add Picture">
            <i class="fas fa-camera"></i>
          </button>
        </div>
      {% endif %}
    </div>
    <h1 class="profile-name">
      {% if user.first_name %}
        {{ user.first_name }} {{ user.last_name }}
      {% else %}
        {{ user.username }}
      {% endif %}
    </h1>
    <p class="profile-subtitle">Computer Science Student • Looking for Opportunities</p>
  </div>
</div>

<!-- Image Upload Modal -->
<div class="modal fade" id="imageUploadModal" tabindex="-1" aria-labelledby="imageUploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageUploadModalLabel">
          {% if profile.profile_picture %}
            Update Profile Picture
          {% else %}
            Add Profile Picture
          {% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="profile-picture-form" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="profile-picture-input" class="form-label">Choose Image</label>
            <input type="file" class="form-control" id="profile-picture-input" name="profile_picture" accept="image/*" required>
            <div class="form-text">Max file size: 5MB. Supported formats: JPG, PNG, GIF</div>
          </div>
          <div id="image-preview-container" class="mt-3" style="display: none;">
            <img id="image-preview" src="#" alt="Preview" class="img-fluid rounded" style="max-height: 200px;">
          </div>
          <div id="upload-errors" class="alert alert-danger" style="display: none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="upload-btn">
            <span id="upload-btn-text">Upload Picture</span>
            <span id="upload-spinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Profile Sections -->
<div class="profile-sections">
  
  <!-- Personal Information -->
  <div class="profile-card">
    <h2 class="section-title">
      <i class="fas fa-user section-icon"></i>
      Personal Information
    </h2>
    
    <div class="info-row">
      <span class="info-label">
        <i class="fas fa-envelope"></i>
        Email
      </span>
      <span class="info-value" id="studentEmailValue">{{ user.email }}</span>
    </div>

    <div class="info-row">
      <span class="info-label">
        <i class="fas fa-phone"></i>
        Phone
      </span>
      <span class="info-value" id="studentPhoneValue">
        {% if profile.phone %}{{ profile.phone }}{% else %}Not provided{% endif %}
      </span>
    </div>

    <div class="info-row">
      <span class="info-label">
        <i class="fas fa-map-marker-alt"></i>
        Location
      </span>
      <span class="info-value" id="studentLocationValue">
        {% if profile.location %}{{ profile.location }}{% else %}Not provided{% endif %}
      </span>
    </div>

    <div class="info-row">
      <span class="info-label">
        <i class="fas fa-birthday-cake"></i>
        Date of Birth
      </span>
      <span class="info-value" id="studentDOBValue">
        {% if profile.date_of_birth %}{{ profile.date_of_birth }}{% else %}Not provided{% endif %}
      </span>
    </div>

    <div class="info-row">
      <span class="info-label">
        <i class="fas fa-linkedin"></i>
        LinkedIn
      </span>
      <span class="info-value" id="studentLinkedInValue">
        {% if profile.linkedin_url %}{{ profile.linkedin_url }}{% else %}Not provided{% endif %}
      </span>
    </div>

    <div class="info-row">
      <span class="info-label">
        <i class="fas fa-university"></i>
        College Name
      </span>
      <span class="info-value" id="studentCollegeValue">
        {% if profile.college_name %}{{ profile.college_name }}{% else %}Not provided{% endif %}
      </span>
    </div>
    
  <button type="button" class="btn-edit"
          data-bs-toggle="modal" data-bs-target="#editStudentInfoModal">
    <i class="fas fa-edit me-2"></i>Edit Information
  </button>

  </div>

<div class="profile-card" id="skills-card">
  <h2 class="section-title">
    <i class="fas fa-cogs section-icon"></i>
    Skills & Expertise
  </h2>

  <!-- simple list-like UI (no percent) -->
  <div id="skills-list">
    {% for s in profile.get_skills_list %}
      <div class="skill-row d-flex justify-content-between align-items-center" data-index="{{ forloop.counter0 }}" data-skill-name="{{ s.name }}">
        <div>
          <div class="skill-name-display">{{ s.name }}</div>
        </div>
        <div class="text-end">
          <button class="btn btn-sm btn-outline-secondary skill-edit-btn"><i class="fas fa-edit"></i></button>
          <button class="btn btn-sm btn-outline-danger skill-delete-btn"><i class="fas fa-trash"></i></button>
        </div>

        <!-- inline editor hidden by default -->
        <div class="skill-editor mt-2 w-100" style="display:none;">
          <div class="row g-2 align-items-center">
            <div class="col-md-8">
              <input type="text" class="form-control form-control-sm skill-name-input" value="{{ s.name }}">
            </div>
            <div class="col-md-4 text-end">
              <button class="btn btn-sm btn-success skill-save-btn"><i class="fas fa-check"></i></button>
              <button class="btn btn-sm btn-secondary skill-cancel-btn"><i class="fas fa-times"></i></button>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-muted">No skills yet — click "Add Skill" to add your first skill.</p>
    {% endfor %}
  </div>

  <div class="skill-tags mt-3" id="skill-chips">
    {% for s in profile.get_skills_list %}
      <button type="button" class="btn btn-outline-primary btn-sm skill-chip me-2 mb-2" data-skill="{{ s.name }}">{{ s.name }}</button>
    {% endfor %}
  </div>

  <div class="mt-3">
    <button id="add-skill-btn" class="btn-edit">
      <i class="fas fa-plus me-2"></i> Add Skill
    </button>
  </div>

  <!-- Single add-skill input (name only) -->
  <div id="add-skill-row" style="display:none;" class="mt-3">
    <div class="row g-2 align-items-center">
      <div class="col-md-8">
        <input id="new-skill-name" class="form-control" placeholder="Skill name (e.g. Node.js)">
      </div>
      <div class="col-md-4 text-end">
        <button id="new-skill-save" class="btn btn-sm btn-primary"><i class="fas fa-check"></i></button>
        <button id="new-skill-cancel" class="btn btn-sm btn-secondary"><i class="fas fa-times"></i></button>
      </div>
    </div>
  </div>
</div>


{# pass endpoint url for AJAX #}
<script>
  window.SKILLS_UPDATE_URL = "{% url 'students:update_skills' %}";
</script>

<!-- Education (experience-like display + edit controls) -->
<div class="profile-card" id="education-card">
  <h2 class="section-title">
    <i class="fas fa-graduation-cap section-icon"></i>
    Education
  </h2>

  <div id="education-list">
    {% for edu in profile.get_education_list %}
      <div class="education-row mb-3 p-3 rounded experience-item" data-index="{{ forloop.counter0 }}"
           data-degree="{{ edu.degree }}" data-institute="{{ edu.institute }}" data-start="{{ edu.start_year }}"
           data-end="{{ edu.end_year }}" data-cgpa="{{ edu.cgpa }}" data-desc="{{ edu.description }}">

        <!-- Display (matches Experience card styling) -->
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="item-title edu-degree">{{ edu.degree }}</div>
            <div class="item-subtitle edu-institute text-primary mb-1">{{ edu.institute }}</div>
            <div class="item-duration text-muted small">{{ edu.start_year }} - {{ edu.end_year }} &nbsp;•&nbsp; CGPA: {{ edu.cgpa }}</div>
            <div class="item-description edu-desc mt-2 text-muted">{{ edu.description }}</div>
          </div>

          <div class="text-end">
            <button class="btn btn-sm btn-outline-secondary edu-edit-btn" title="Edit"><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-outline-danger edu-delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
          </div>
        </div>

        <!-- inline editor (hidden by default) - unchanged so existing JS continues to work -->
        <div class="education-editor mt-3" style="display:none;">
          <div class="row g-2">
            <div class="col-md-6">
              <input type="text" class="form-control form-control-sm edu-input-degree" placeholder="Degree / Course" value="{{ edu.degree }}">
            </div>
            <div class="col-md-6">
              <input type="text" class="form-control form-control-sm edu-input-institute" placeholder="Institute" value="{{ edu.institute }}">
            </div>
            <div class="col-md-3">
              <input type="text" class="form-control form-control-sm edu-input-start" placeholder="Start Year" value="{{ edu.start_year }}">
            </div>
            <div class="col-md-3">
              <input type="text" class="form-control form-control-sm edu-input-end" placeholder="End Year" value="{{ edu.end_year }}">
            </div>
            <div class="col-md-3">
              <input type="text" class="form-control form-control-sm edu-input-cgpa" placeholder="CGPA (e.g. 8.5/10)" value="{{ edu.cgpa }}">
            </div>
            <div class="col-md-12 mt-2">
              <textarea class="form-control form-control-sm edu-input-desc" placeholder="Description / coursework" rows="2">{{ edu.description }}</textarea>
            </div>
            <div class="col-md-12 text-end mt-2">
              <button class="btn btn-sm btn-success edu-save-btn"><i class="fas fa-check"></i> Save</button>
              <button class="btn btn-sm btn-secondary edu-cancel-btn"><i class="fas fa-times"></i> Cancel</button>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-muted">No education entries yet — click "Add Education" to add.</p>
    {% endfor %}
  </div>

  <div class="mt-3">
    <button id="add-edu-btn" class="btn-edit"><i class="fas fa-plus me-2"></i> Add Education</button>
  </div>

  <div id="add-edu-row" style="display:none;" class="mt-3">
    <div class="row g-2">
      <div class="col-md-6">
        <input id="new-edu-degree" class="form-control" placeholder="Degree / Course">
      </div>
      <div class="col-md-6">
        <input id="new-edu-institute" class="form-control" placeholder="Institute">
      </div>
      <div class="col-md-3">
        <input id="new-edu-start" class="form-control" placeholder="Start Year">
      </div>
      <div class="col-md-3">
        <input id="new-edu-end" class="form-control" placeholder="End Year">
      </div>
      <div class="col-md-3">
        <input id="new-edu-cgpa" class="form-control" placeholder="CGPA">
      </div>
      <div class="col-md-12 mt-2">
        <textarea id="new-edu-desc" class="form-control" placeholder="Description / coursework" rows="2"></textarea>
      </div>
      <div class="col-md-12 text-end mt-2">
        <button id="new-edu-save" class="btn btn-primary btn-sm"><i class="fas fa-check"></i> Save</button>
        <button id="new-edu-cancel" class="btn btn-secondary btn-sm"><i class="fas fa-times"></i> Cancel</button>
      </div>
    </div>
  </div>
</div>



  <!-- Experience -->
  <div class="profile-card">
    <h2 class="section-title">
      <i class="fas fa-briefcase section-icon"></i>
      Experience
    </h2>
    
    <div class="experience-item">
      <div class="item-title">Web Development Intern</div>
      <div class="item-subtitle">TechStart Solutions</div>
      <div class="item-duration">June 2023 - August 2023 • 3 months</div>
      <div class="item-description">
        Developed responsive web applications using Django and React. Collaborated with senior developers to implement new features and optimize database queries.
      </div>
    </div>
    
    <a href="#" class="btn-edit">
      <i class="fas fa-plus me-2"></i>Add Experience
    </a>
  </div>

  <!-- Projects -->
  <div class="profile-card">
    <h2 class="section-title">
      <i class="fas fa-code section-icon"></i>
      Projects
    </h2>
    
    <div class="experience-item">
      <div class="item-title">E-Commerce Platform</div>
      <div class="item-subtitle">Django, React, PostgreSQL</div>
      <div class="item-duration">March 2024 - May 2024</div>
      <div class="item-description">
        Built a full-stack e-commerce platform with user authentication, product catalog, shopping cart, and payment integration.
      </div>
    </div>
    
    <a href="#" class="btn-edit">
      <i class="fas fa-plus me-2"></i>Add Project
    </a>
  </div>

  <!-- Statistics -->
  <div class="profile-card">
    <h2 class="section-title">
      <i class="fas fa-chart-bar section-icon"></i>
      Profile Statistics
    </h2>
    
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-number">15</div>
        <div class="stat-label">Profile Views</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">8</div>
        <div class="stat-label">Applications</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">3</div>
        <div class="stat-label">Interviews</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">95%</div>
        <div class="stat-label">Profile Complete</div>
      </div>
    </div>
  </div>

</div>

<!-- Back to Dashboard -->
<div class="text-center mt-4 mb-5">
  <a href="{% url 'students:student_dashboard' %}" class="btn-edit">
    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
  </a>
</div>

<div class="modal fade" id="editStudentInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="editStudentInfoForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-user-graduate me-2"></i>Edit Student Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Phone</label>
            <input type="text" class="form-control" name="phone" value="{{ profile.phone }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Location</label>
            <input type="text" class="form-control" name="location" value="{{ profile.location }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Date of Birth</label>
            <input type="date" class="form-control" name="date_of_birth" value="{{ profile.date_of_birth|date:'Y-m-d' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">LinkedIn URL</label>
            <input type="url" class="form-control" name="linkedin_url" value="{{ profile.linkedin_url }}">
          </div>
          <div class="mb-3">
            <label class="form-label">College</label>
            <input type="text" class="form-control" name="college" value="{{ profile.college }}">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Pass Django profile URLs to JS for upload/delete (already present in your template)
  window.profileUrls = {
      deleteProfilePicture: "{% url 'students:delete_profile_picture' %}",
      uploadProfilePicture: "{% url 'students:upload_profile_picture' %}"
  };
</script>

{{ profile.get_skills_list|json_script:"initial-skills" }}
<script>
  window.INITIAL_SKILLS = JSON.parse(document.getElementById('initial-skills').textContent || '[]');
  window.SKILLS_UPDATE_URL = "{% url 'students:update_skills' %}";
</script>


{# expose initial data to JS via json_script #}
{{ profile.get_education_list|json_script:"initial-education" }}
<script>
  window.INITIAL_EDUCATION = JSON.parse(document.getElementById('initial-education').textContent || '[]');
  window.EDU_UPDATE_URL = "{% url 'students:update_education' %}";
</script>


<script src="{% static 'js/student_profile.js' %}"></script>

{% endblock %}
